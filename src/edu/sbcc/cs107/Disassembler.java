package edu.sbcc.cs107;

/**
 * @author Luke Lewis
 * CS 107: Disassembler Project
 * 
 * This code implements the disassembler as well as pulling apart the Hex file. The hex file format
 * is documented at http://www.keil.com/support/docs/1584/
 */
public class Disassembler {
	
	
	private final String[] OPERATIONS = {"0100000101", "0001110", "0100001011", "0101011", "00100", "0000000000", "1011101000"}; //unique keys from each instruction to check against our extracted halfword
	/**
	 * Extracts the register operand from a halfword.
	 * 
	 * The register operand (e.g. r0) is used by many mnemonics and is embedded in the data halfword.
	 * It position is specified by the least significant bit and most significant bit. This value is
	 * extracted and concatenated with "r" to give us the desired register.
	 * 
	 * @param hw Halfword that contains the machine code data.
	 * @param lsBitPosition Encoded register value (LSB)
	 * @param msBitPosition Encoded register value (MSB)
	 * @return Register field designation (e.g. r1)
	 */
	public String getRegister(Halfword hw, int lsBitPosition, int msBitPosition) {
		int data = hw.getData();
		String binaryString = Integer.toBinaryString(data); //doesn't show leading zeroes
		binaryString = ("0000000000000000" + binaryString).substring(binaryString.length()); //makes sure the binary string is 16 chars with leading zeroes
		int end = 15 - lsBitPosition; //to get msb/lsb in the string version of binary sequence
		int start = 15 - msBitPosition;
		String regString = binaryString.substring(start, end + 1); //what we use to get register value
		int regInt = Integer.parseInt(regString, 2);
		return "r" + Integer.toString(regInt);
	}
	
	/**
	 * Extracts the immediate operand from a halfword.
	 * 
	 * Same as the getRegister function but returns the embedded immediate value (e.g. #4).
	 *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
	 * @param hw Halfword that contains the machine code data.
	 * @param lsBitPosition Encoded immediate value (LSB)
	 * @param msBitPosition Encoded immediate value (MSB)
	 * @return Immediate field designation (e.g. #12)
	 */
	public String getImmediate(Halfword hw, int lsBitPosition, int msBitPosition) {
		String ret = getRegister(hw, lsBitPosition, msBitPosition);
		ret = ret.substring(1); //pretty much the same code as getRegister, except you need to take off the r and add a # in front
		return "#" + ret;
	}

	/**
	 * Returns a formatted string consisting of the Mnemonic and Operands for the given halfword.
	 * 
	 * The halfword is decoded into its corresponding mnemonic and any optional operands. The return
	 * value is a formatted string with an 8 character wide field for the mnemonic (left justified) a
	 * single space and then any operands.
	 * 
	 * @param hw Halfword that contains the machine code data.
	 * @return Formatted string containing the mnemonic and any operands.
	 */
	public String dissassembleToString(Halfword hw) {
		int data = hw.getData();
		String mnemonic = "";
		String operands = "";
		String stringBinaryData = Integer.toBinaryString(data);
		stringBinaryData = ("0000000000000000" + stringBinaryData).substring(stringBinaryData.length()); //we now have a string that shows us the halfword in binary with leading zeroes
		for (int i = 0; i < OPERATIONS.length; i++) { //iterating through our OPERATIONS key/matcher
			String subData = stringBinaryData.substring(0, OPERATIONS[i].length()); //cuts our current Binary string to the length of the binary key its comparing to
			if (subData.equals(OPERATIONS[i])) {
				switch (i) { //switch statement to handle the 7 different cases of matching
				case 0: mnemonic = "ADCS";
						operands = getRegister(hw, 0, 2) + ", " + getRegister(hw, 3, 5);
						break;
				case 1: mnemonic = "ADDS";
						operands = getRegister(hw, 0, 2) + ", " + getRegister(hw, 3, 5) + ", " + getImmediate(hw, 6, 8);
						break;
				case 2: mnemonic = "CMN";
						operands = getRegister(hw, 0, 2) + ", " + getRegister(hw, 3, 5);
						break;
				case 3: mnemonic = "LDRSB";
						operands = getRegister(hw, 0, 2) + ", [" + getRegister(hw, 3, 5) + ", " + getRegister(hw, 6, 8) + "]";
						break;
				case 4: mnemonic = "MOVS";
						operands = getRegister(hw, 8, 10) + ", " + getImmediate(hw, 0, 7);
						break;
				case 5: mnemonic = "MOVS";
						operands = getRegister(hw, 0, 2) + ", " + getRegister(hw, 3, 5);
						break;
				case 6: mnemonic = "REV";
						operands = getRegister(hw, 0, 2) + ", " + getRegister(hw, 3, 5);
						break;
				default: break;
				}
			}
			//if (exitLoop) break; //to break out of the for loop since the breaks in the switch statement only breaks the
		}
		String ret = String.format("%-8s %s", mnemonic, operands);
		return ret;
	}
	
}
